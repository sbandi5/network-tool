package com.cybersec.exploit;

import java.io.BufferedReader;
import java.io.InputStreamReader;
import java.net.Socket;
import java.util.*;

import org.springframework.stereotype.Service;

@Service
public class ExploitEngine {
    private final Map<String, String> vulnDB = Map.of(
        "ftp", "Anonymous FTP access vulnerability",
        "apache/2.2", "Apache 2.2 - outdated, vulnerable to CVE-2017-3167",
        "mysql", "MySQL - weak root access if no password",
        "openssh", "OpenSSH - check for CVE-2021-41617"
    );

    public static void logExploitToFile(String content) {
        try (java.io.FileWriter writer = new java.io.FileWriter("exploit-log.txt", true)) {
            writer.write(new Date() + " - " + content + "\n");
        } catch (Exception e) {
            System.out.println("Failed to write to log: " + e.getMessage());
        }
    }
    

    public Map<String, String> runExploit(String target, int port) {
        Map<String, String> result = new HashMap<>();
        result.put("target", target);
        result.put("port", String.valueOf(port));

        try (Socket socket = new Socket(target, port);
             BufferedReader reader = new BufferedReader(new InputStreamReader(socket.getInputStream()))) {

            String banner = reader.readLine();
            result.put("banner", banner != null ? banner : "unknown");

            // Simulated vulnerability check
            if (banner != null && banner.toLowerCase().contains("ftp")) {
                result.put("exploit", "Anonymous FTP Login Vulnerability Detected");
            } else if (banner != null && banner.toLowerCase().contains("apache")) {
                result.put("exploit", "Outdated Apache Version Possible");
            } else {
                result.put("exploit", "No known vulnerability detected");
            }

        } catch (Exception e) {
            result.put("status", "Failed to connect or read banner");
        }
        logExploitToFile("Target: " + target + ", Port: " + port + ", Exploit: " + result.get("exploit"));

        return result;
    }
}